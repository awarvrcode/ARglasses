<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D è™›æ“¬å¤ªé™½çœ¼é¡ AR</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #000;
        }
        
        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        
        video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }
        
        #output {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: scaleX(-1);
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 18px;
            text-align: center;
            background: rgba(0,0,0,0.8);
            padding: 30px 50px;
            border-radius: 15px;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        
        .loading small {
            display: block;
            margin-top: 10px;
            font-size: 14px;
            color: #aaa;
        }
        
        .controls {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 100;
        }
        
        button {
            padding: 14px 28px;
            background: rgba(255,255,255,0.95);
            border: none;
            border-radius: 30px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            color: #333;
        }
        
        button:hover {
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }
        
        button.active {
            background: #4CAF50;
            color: white;
        }
        
        .info {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 100;
            font-family: monospace;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        @media (max-width: 768px) {
            button {
                padding: 12px 20px;
                font-size: 14px;
            }
            
            .controls {
                bottom: 20px;
                gap: 8px;
            }
        }
    </style>
</head>
<body>
    <div id="container">
        <div class="loading" id="loading">
            è¼‰å…¥ä¸­...<br>
            <small>æ­£åœ¨åˆå§‹åŒ–ç›¸æ©Ÿå’Œ AI æ¨¡å‹</small>
        </div>
        
        <video id="video" playsinline autoplay></video>
        <canvas id="output"></canvas>
        
        <div class="controls">
            <button id="model1" class="active">ç¶“å…¸æ¬¾</button>
            <button id="model2">é£›è¡Œå“¡</button>
            <button id="model3">åœ“æ¡†</button>
        </div>
        
        <div class="info" id="info">FPS: --</div>
    </div>

    <!-- MediaPipe CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
    
    <!-- Three.js -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.150.0/build/three.min.js" crossorigin="anonymous"></script>

    <script>
        // ==================== å…¨åŸŸè®Šæ•¸ ====================
        const video = document.getElementById('video');
        const canvas = document.getElementById('output');
        const loading = document.getElementById('loading');
        const infoDiv = document.getElementById('info');
        
        let scene, camera, renderer, glassesModel;
        let currentStyle = 'classic';
        let lastTime = Date.now();
        let frameCount = 0;
        
        // ==================== å¹³æ»‘æ¿¾æ³¢å™¨ ====================
        class SmoothFilter {
            constructor(smoothingFactor = 0.4) {
                this.smoothingFactor = smoothingFactor;
                this.previousValues = {};
            }
            
            smooth(currentValue, key) {
                if (!this.previousValues[key]) {
                    this.previousValues[key] = currentValue;
                    return currentValue;
                }
                
                if (Array.isArray(currentValue)) {
                    const smoothed = currentValue.map((val, i) => {
                        return this.previousValues[key][i] + 
                               (val - this.previousValues[key][i]) * this.smoothingFactor;
                    });
                    this.previousValues[key] = smoothed;
                    return smoothed;
                } else {
                    const smoothed = this.previousValues[key] + 
                                   (currentValue - this.previousValues[key]) * this.smoothingFactor;
                    this.previousValues[key] = smoothed;
                    return smoothed;
                }
            }
        }
        
        const smoothFilter = new SmoothFilter(0.4);
        
        // ==================== Three.js å ´æ™¯è¨­å®š ====================
        function initThreeJS() {
            console.log('åˆå§‹åŒ– Three.js...');
            
            scene = new THREE.Scene();
            
            // ä½¿ç”¨èˆ‡ MediaPipe åŒ¹é…çš„ç›¸æ©Ÿè¨­ç½®
            const aspect = window.innerWidth / window.innerHeight;
            camera = new THREE.PerspectiveCamera(63, aspect, 0.01, 1000);
            camera.position.set(0, 0, 0);
            
            renderer = new THREE.WebGLRenderer({
                canvas: canvas,
                alpha: true,
                antialias: true
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.setClearColor(0x000000, 0);
            
            // å…‰æºè¨­ç½®
            const ambientLight = new THREE.AmbientLight(0xffffff, 1.2);
            scene.add(ambientLight);
            
            const directionalLight1 = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight1.position.set(0, 1, 1);
            scene.add(directionalLight1);
            
            const directionalLight2 = new THREE.DirectionalLight(0xffffff, 0.4);
            directionalLight2.position.set(-1, 0, 0.5);
            scene.add(directionalLight2);
            
            console.log('âœ“ Three.js åˆå§‹åŒ–å®Œæˆ');
        }
        
        // ==================== å»ºç«‹ç¶“å…¸æ¬¾çœ¼é¡ ====================
        function createClassicGlasses() {
            const group = new THREE.Group();
            
            const frameMaterial = new THREE.MeshPhongMaterial({
                color: 0x000000,
                shininess: 80,
                specular: 0x222222
            });
            
            const lensMaterial = new THREE.MeshPhongMaterial({
                color: 0x1a1a1a,
                transparent: true,
                opacity: 0.85,
                shininess: 100,
                specular: 0x444444
            });
            
            // å·¦é¡ç‰‡å’Œé¡æ¡†
            const leftLens = new THREE.Mesh(
                new THREE.CircleGeometry(0.045, 32),
                lensMaterial
            );
            leftLens.position.set(-0.065, 0, 0);
            group.add(leftLens);
            
            const leftFrame = new THREE.Mesh(
                new THREE.TorusGeometry(0.045, 0.006, 16, 32),
                frameMaterial
            );
            leftFrame.position.set(-0.065, 0, 0);
            group.add(leftFrame);
            
            // å³é¡ç‰‡å’Œé¡æ¡†
            const rightLens = new THREE.Mesh(
                new THREE.CircleGeometry(0.045, 32),
                lensMaterial
            );
            rightLens.position.set(0.065, 0, 0);
            group.add(rightLens);
            
            const rightFrame = new THREE.Mesh(
                new THREE.TorusGeometry(0.045, 0.006, 16, 32),
                frameMaterial
            );
            rightFrame.position.set(0.065, 0, 0);
            group.add(rightFrame);
            
            // é¼»æ¨‘
            const bridge = new THREE.Mesh(
                new THREE.CylinderGeometry(0.005, 0.005, 0.03, 8),
                frameMaterial
            );
            bridge.rotation.z = Math.PI / 2;
            group.add(bridge);
            
            // é¡è…¿
            const leftTemple = new THREE.Mesh(
                new THREE.CylinderGeometry(0.004, 0.004, 0.15, 8),
                frameMaterial
            );
            leftTemple.rotation.z = Math.PI / 2;
            leftTemple.position.set(-0.14, 0, 0);
            group.add(leftTemple);
            
            const rightTemple = new THREE.Mesh(
                new THREE.CylinderGeometry(0.004, 0.004, 0.15, 8),
                frameMaterial
            );
            rightTemple.rotation.z = Math.PI / 2;
            rightTemple.position.set(0.14, 0, 0);
            group.add(rightTemple);
            
            return group;
        }
        
        // ==================== å»ºç«‹é£›è¡Œå“¡æ¬¾çœ¼é¡ ====================
        function createAviatorGlasses() {
            const group = new THREE.Group();
            
            const frameMaterial = new THREE.MeshPhongMaterial({
                color: 0xC0C0C0,
                shininess: 100
            });
            
            const lensMaterial = new THREE.MeshPhongMaterial({
                color: 0x2a2a2a,
                transparent: true,
                opacity: 0.8,
                shininess: 120
            });
            
            // å·¦é¡ç‰‡
            const leftLens = new THREE.Mesh(
                new THREE.CircleGeometry(0.05, 32),
                lensMaterial
            );
            leftLens.scale.set(1, 1.1, 1);
            leftLens.position.set(-0.065, 0, 0);
            group.add(leftLens);
            
            const leftFrame = new THREE.Mesh(
                new THREE.TorusGeometry(0.05, 0.005, 16, 32),
                frameMaterial
            );
            leftFrame.scale.set(1, 1.1, 1);
            leftFrame.position.set(-0.065, 0, 0);
            group.add(leftFrame);
            
            // å³é¡ç‰‡
            const rightLens = new THREE.Mesh(
                new THREE.CircleGeometry(0.05, 32),
                lensMaterial
            );
            rightLens.scale.set(1, 1.1, 1);
            rightLens.position.set(0.065, 0, 0);
            group.add(rightLens);
            
            const rightFrame = new THREE.Mesh(
                new THREE.TorusGeometry(0.05, 0.005, 16, 32),
                frameMaterial
            );
            rightFrame.scale.set(1, 1.1, 1);
            rightFrame.position.set(0.065, 0, 0);
            group.add(rightFrame);
            
            // é¼»æ¨‘
            const bridgeTop = new THREE.Mesh(
                new THREE.CylinderGeometry(0.004, 0.004, 0.025, 8),
                frameMaterial
            );
            bridgeTop.rotation.z = Math.PI / 2;
            bridgeTop.position.y = 0.015;
            group.add(bridgeTop);
            
            // é¡è…¿
            const leftTemple = new THREE.Mesh(
                new THREE.CylinderGeometry(0.004, 0.004, 0.15, 8),
                frameMaterial
            );
            leftTemple.rotation.z = Math.PI / 2;
            leftTemple.position.set(-0.14, 0, 0);
            group.add(leftTemple);
            
            const rightTemple = new THREE.Mesh(
                new THREE.CylinderGeometry(0.004, 0.004, 0.15, 8),
                frameMaterial
            );
            rightTemple.rotation.z = Math.PI / 2;
            rightTemple.position.set(0.14, 0, 0);
            group.add(rightTemple);
            
            return group;
        }
        
        // ==================== å»ºç«‹åœ“æ¡†æ¬¾çœ¼é¡ ====================
        function createRoundGlasses() {
            const group = new THREE.Group();
            
            const frameMaterial = new THREE.MeshPhongMaterial({
                color: 0x8B4513,
                shininess: 60
            });
            
            const lensMaterial = new THREE.MeshPhongMaterial({
                color: 0x3a2817,
                transparent: true,
                opacity: 0.75,
                shininess: 80
            });
            
            const radius = 0.042;
            
            // å·¦é¡ç‰‡
            const leftLens = new THREE.Mesh(
                new THREE.CircleGeometry(radius, 32),
                lensMaterial
            );
            leftLens.position.set(-0.06, 0, 0);
            group.add(leftLens);
            
            const leftFrame = new THREE.Mesh(
                new THREE.TorusGeometry(radius, 0.007, 16, 32),
                frameMaterial
            );
            leftFrame.position.set(-0.06, 0, 0);
            group.add(leftFrame);
            
            // å³é¡ç‰‡
            const rightLens = new THREE.Mesh(
                new THREE.CircleGeometry(radius, 32),
                lensMaterial
            );
            rightLens.position.set(0.06, 0, 0);
            group.add(rightLens);
            
            const rightFrame = new THREE.Mesh(
                new THREE.TorusGeometry(radius, 0.007, 16, 32),
                frameMaterial
            );
            rightFrame.position.set(0.06, 0, 0);
            group.add(rightFrame);
            
            // é¼»æ¨‘
            const bridge = new THREE.Mesh(
                new THREE.CylinderGeometry(0.005, 0.005, 0.025, 8),
                frameMaterial
            );
            bridge.rotation.z = Math.PI / 2;
            group.add(bridge);
            
            // é¡è…¿
            const leftTemple = new THREE.Mesh(
                new THREE.CylinderGeometry(0.005, 0.005, 0.15, 8),
                frameMaterial
            );
            leftTemple.rotation.z = Math.PI / 2;
            leftTemple.position.set(-0.135, 0, 0);
            group.add(leftTemple);
            
            const rightTemple = new THREE.Mesh(
                new THREE.CylinderGeometry(0.005, 0.005, 0.15, 8),
                frameMaterial
            );
            rightTemple.rotation.z = Math.PI / 2;
            rightTemple.position.set(0.135, 0, 0);
            group.add(rightTemple);
            
            return group;
        }
        
        // ==================== åˆ‡æ›çœ¼é¡æ¨£å¼ ====================
        function switchGlassesStyle(style) {
            if (glassesModel) {
                scene.remove(glassesModel);
            }
            
            switch(style) {
                case 'classic':
                    glassesModel = createClassicGlasses();
                    break;
                case 'aviator':
                    glassesModel = createAviatorGlasses();
                    break;
                case 'round':
                    glassesModel = createRoundGlasses();
                    break;
            }
            
            scene.add(glassesModel);
            currentStyle = style;
        }
        
        // ==================== MediaPipe Face Mesh è¨­å®š ====================
        const faceMesh = new FaceMesh({
            locateFile: (file) => {
                return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`;
            }
        });
        
        faceMesh.setOptions({
            maxNumFaces: 1,
            refineLandmarks: true,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });
        
        faceMesh.onResults(onResults);
        
        // ==================== è™•ç†åµæ¸¬çµæœ ====================
        function onResults(results) {
            if (loading.style.display !== 'none') {
                loading.style.display = 'none';
            }
            
            frameCount++;
            const now = Date.now();
            if (now - lastTime > 1000) {
                infoDiv.textContent = `FPS: ${frameCount}`;
                frameCount = 0;
                lastTime = now;
            }
            
            if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
                const landmarks = results.multiFaceLandmarks[0];
                updateGlassesPosition(landmarks);
            } else {
                if (glassesModel) {
                    glassesModel.visible = false;
                }
            }
            
            renderer.render(scene, camera);
        }
        
        // ==================== æ›´æ–°çœ¼é¡ä½ç½®ï¼ˆå®Œå…¨é‡å¯«ï¼‰====================
        function updateGlassesPosition(landmarks) {
            if (!glassesModel) return;
            
            glassesModel.visible = true;
            
            // ===== é—œéµç‰¹å¾µé» =====
            // ä½¿ç”¨çœ¼ç›ä¸­å¿ƒé»ï¼Œè€Œä¸æ˜¯çœ¼è§’
            const leftEyeCenter = landmarks[468];   // å·¦çœ¼ä¸­å¿ƒ
            const rightEyeCenter = landmarks[473];  // å³çœ¼ä¸­å¿ƒ
            const leftEyeOuter = landmarks[33];     // å·¦çœ¼å¤–è§’
            const rightEyeOuter = landmarks[263];   // å³çœ¼å¤–è§’
            const noseTip = landmarks[1];           // é¼»å°–
            const foreheadCenter = landmarks[10];   // é¡é ­ä¸­å¿ƒ
            
            // ===== è¨ˆç®—çœ¼é¡ä¸­å¿ƒä½ç½® =====
            const centerX = (leftEyeCenter.x + rightEyeCenter.x) / 2;
            const centerY = (leftEyeCenter.y + rightEyeCenter.y) / 2;
            const centerZ = (leftEyeCenter.z + rightEyeCenter.z) / 2;
            
            // ===== æ”¹é€²çš„åº§æ¨™è½‰æ› =====
            const videoAspect = video.videoWidth / video.videoHeight;
            const fov = 63 * Math.PI / 180;  // ç›¸æ©Ÿ FOV è½‰å¼§åº¦
            
            // è¨ˆç®—å¯¦éš›çš„ 3D ä½ç½®
            const rawX = (centerX - 0.5) * 2;
            const rawY = -(centerY - 0.5) * 2;
            
            // â­ é—œéµæ”¹é€²ï¼šä½¿ç”¨ MediaPipe çš„ z å€¼è¨ˆç®—æ·±åº¦
            // MediaPipe çš„ z å€¼ï¼šè² å€¼è¡¨ç¤ºå¾€å‰ï¼ˆæœå‘ç›¸æ©Ÿï¼‰
            const depthScale = 2.0;  // æ·±åº¦ç¸®æ”¾ä¿‚æ•¸
            const rawZ = centerZ * depthScale;
            
            // æ‡‰ç”¨è¦–è§’æ¯”ä¾‹æ ¡æ­£
            const distance = 0.5;  // åŸºç¤è·é›¢
            const correctedX = rawX * videoAspect * (distance - rawZ);
            const correctedY = rawY * (distance - rawZ);
            const correctedZ = rawZ - distance;
            
            // å¹³æ»‘æ¿¾æ³¢
            const smoothedPos = smoothFilter.smooth(
                [correctedX, correctedY, correctedZ], 
                'position'
            );
            
            glassesModel.position.set(
                smoothedPos[0], 
                smoothedPos[1], 
                smoothedPos[2]
            );
            
            // ===== è¨ˆç®—æ—‹è½‰ï¼ˆæ”¹é€²ç‰ˆï¼‰=====
            // Roll - å·¦å³æ­ªé ­
            const rawRoll = Math.atan2(
                rightEyeOuter.y - leftEyeOuter.y,
                rightEyeOuter.x - leftEyeOuter.x
            );
            
            // Yaw - å·¦å³è½‰é ­ï¼ˆä½¿ç”¨ z æ·±åº¦å·®ç•°ï¼‰
            const zDiff = rightEyeOuter.z - leftEyeOuter.z;
            const rawYaw = Math.atan(zDiff / ((rightEyeOuter.x - leftEyeOuter.x) * videoAspect));
            
            // Pitch - ä¸Šä¸‹é»é ­
            const noseToEyeY = centerY - noseTip.y;
            const noseToEyeZ = centerZ - noseTip.z;
            const rawPitch = Math.atan2(noseToEyeY, Math.abs(noseToEyeZ)) * 0.5;
            
            // å¹³æ»‘æ—‹è½‰
            const smoothedRot = smoothFilter.smooth(
                [rawPitch, rawYaw, rawRoll], 
                'rotation'
            );
            
            glassesModel.rotation.set(
                smoothedRot[0], 
                smoothedRot[1], 
                smoothedRot[2]
            );
            
            // ===== è¨ˆç®—ç¸®æ”¾ =====
            const eyeDistance = Math.sqrt(
                Math.pow((rightEyeCenter.x - leftEyeCenter.x) * videoAspect, 2) +
                Math.pow(rightEyeCenter.y - leftEyeCenter.y, 2) +
                Math.pow(rightEyeCenter.z - leftEyeCenter.z, 2)
            );
            
            // æ ¹æ“šæ·±åº¦èª¿æ•´ç¸®æ”¾
            const depthFactor = 1.0 / (1.0 - rawZ * 0.5);
            const baseScale = 2.1;
            const rawScale = eyeDistance * baseScale * depthFactor;
            
            // å¹³æ»‘ç¸®æ”¾
            const smoothedScale = smoothFilter.smooth(rawScale, 'scale');
            glassesModel.scale.set(smoothedScale, smoothedScale, smoothedScale);
            
            // é™¤éŒ¯è³‡è¨Š
            if (frameCount % 60 === 0) {
                console.log('ä½ç½®:', smoothedPos.map(v => v.toFixed(3)));
                console.log('æ·±åº¦ Z:', rawZ.toFixed(3));
                console.log('ç¸®æ”¾:', smoothedScale.toFixed(3));
            }
        }
        
        // ==================== æŒ‰éˆ•äº‹ä»¶ ====================
        document.getElementById('model1').addEventListener('click', () => {
            switchGlassesStyle('classic');
            updateActiveButton('model1');
        });
        
        document.getElementById('model2').addEventListener('click', () => {
            switchGlassesStyle('aviator');
            updateActiveButton('model2');
        });
        
        document.getElementById('model3').addEventListener('click', () => {
            switchGlassesStyle('round');
            updateActiveButton('model3');
        });
        
        function updateActiveButton(activeId) {
            document.querySelectorAll('button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(activeId).classList.add('active');
        }
        
        // ==================== è¦–çª—å¤§å°èª¿æ•´ ====================
        window.addEventListener('resize', () => {
            const aspect = window.innerWidth / window.innerHeight;
            camera.aspect = aspect;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
        
        // ==================== åˆå§‹åŒ–å•Ÿå‹• ====================
        async function init() {
            console.log('ğŸš€ é–‹å§‹åˆå§‹åŒ–æ‡‰ç”¨...');
            
            try {
                if (typeof THREE === 'undefined') {
                    throw new Error('Three.js æœªè¼‰å…¥');
                }
                if (typeof FaceMesh === 'undefined') {
                    throw new Error('MediaPipe Face Mesh æœªè¼‰å…¥');
                }
                if (typeof Camera === 'undefined') {
                    throw new Error('MediaPipe Camera æœªè¼‰å…¥');
                }
                
                console.log('âœ“ æ‰€æœ‰åº«è¼‰å…¥æˆåŠŸ');
                
                initThreeJS();
                switchGlassesStyle('classic');
                
                console.log('ğŸ“· å•Ÿå‹•ç›¸æ©Ÿ...');
                const cameraInstance = new Camera(video, {
                    onFrame: async () => {
                        await faceMesh.send({image: video});
                    },
                    width: 1280,
                    height: 720,
                    facingMode: 'user'
                });
                
                await cameraInstance.start();
                console.log('âœ“ ç›¸æ©Ÿå•Ÿå‹•æˆåŠŸ');
                
            } catch (error) {
                console.error('âŒ åˆå§‹åŒ–å¤±æ•—:', error);
                loading.innerHTML = `
                    åˆå§‹åŒ–å¤±æ•—<br>
                    <small>${error.message}</small><br>
                    <small style="margin-top:10px;display:block">è«‹é‡æ–°æ•´ç†é é¢</small>
                `;
            }
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
