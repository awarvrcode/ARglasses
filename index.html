<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebAR 虛擬太陽眼鏡 </title>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: #1a1a1a;
            font-family: Arial, sans-serif;
        }
        
        .container {
            position: relative;
            max-width: 100vw;
            max-height: 100vh;
        }
        
        video {
            display: none;
        }
        
        canvas {
            display: block;
            max-width: 100%;
            max-height: 100vh;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 18px;
            text-align: center;
        }
        
        .controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
        }
        
        button {
            padding: 12px 24px;
            background: rgba(255,255,255,0.9);
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        button:hover {
            background: white;
            transform: scale(1.05);
        }
        
        button.active {
            background: #4CAF50;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="loading" id="loading">載入中...</div>
        <video id="video" playsinline></video>
        <canvas id="canvas"></canvas>
        
        <div class="controls">
            <button id="style1" class="active">經典款</button>
            <button id="style2">飛行員</button>
            <button id="style3">圓框</button>
        </div>
    </div>

    <!-- MediaPipe Face Mesh -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const loading = document.getElementById('loading');
        
        let currentStyle = 'classic';
        let sunglassesImage = null;
        
        // 太陽眼鏡樣式選擇
        document.getElementById('style1').addEventListener('click', () => {
            currentStyle = 'classic';
            updateActiveButton('style1');
        });
        
        document.getElementById('style2').addEventListener('click', () => {
            currentStyle = 'aviator';
            updateActiveButton('style2');
        });
        
        document.getElementById('style3').addEventListener('click', () => {
            currentStyle = 'round';
            updateActiveButton('style3');
        });
        
        function updateActiveButton(activeId) {
            document.querySelectorAll('button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(activeId).classList.add('active');
        }
        
        // 初始化 Face Mesh
        const faceMesh = new FaceMesh({
            locateFile: (file) => {
                return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`;
            }
        });
        
        faceMesh.setOptions({
            maxNumFaces: 1,
            refineLandmarks: true,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });
        
        faceMesh.onResults(onResults);
        
        function onResults(results) {
            // 設置 canvas 尺寸
            canvas.width = results.image.width;
            canvas.height = results.image.height;
            
            // 清除並繪製影像
            ctx.save();
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);
            
            // 隱藏載入提示
            if (loading.style.display !== 'none') {
                loading.style.display = 'none';
            }
            
            // 繪製太陽眼鏡
            if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
                const landmarks = results.multiFaceLandmarks[0];
                drawSunglasses(landmarks);
            }
            
            ctx.restore();
        }
        
        function drawSunglasses(landmarks) {
            // 關鍵特徵點
            const leftEyeOuter = landmarks[33];   // 左眼外角
            const leftEyeInner = landmarks[133];  // 左眼內角
            const rightEyeInner = landmarks[362]; // 右眼內角
            const rightEyeOuter = landmarks[263]; // 右眼外角
            const noseBridge = landmarks[168];    // 鼻樑
            const leftEyeTop = landmarks[159];    // 左眼上方
            const rightEyeTop = landmarks[386];   // 右眼上方
            
            // 計算眼鏡參數
            const glassesWidth = Math.abs(rightEyeOuter.x - leftEyeOuter.x) * canvas.width;
            const glassesHeight = glassesWidth * 0.35;
            
            // 計算中心點和角度
            const centerX = (leftEyeOuter.x + rightEyeOuter.x) / 2 * canvas.width;
            const centerY = (leftEyeOuter.y + rightEyeOuter.y) / 2 * canvas.height;
            const angle = Math.atan2(
                rightEyeOuter.y - leftEyeOuter.y,
                rightEyeOuter.x - leftEyeOuter.x
            );
            
            ctx.save();
            ctx.translate(centerX, centerY);
            ctx.rotate(angle);
            
            // 根據樣式繪製
            switch(currentStyle) {
                case 'classic':
                    drawClassicSunglasses(glassesWidth, glassesHeight);
                    break;
                case 'aviator':
                    drawAviatorSunglasses(glassesWidth, glassesHeight);
                    break;
                case 'round':
                    drawRoundSunglasses(glassesWidth, glassesHeight);
                    break;
            }
            
            ctx.restore();
        }
        


        function drawClassicSunglasses(width, height) {
    const lensWidth = width * 0.38;  // 每個鏡片寬度
    const lensHeight = height * 0.8;
    const bridge = width * 0.4;     // 鼻樑寬度
    const gap = bridge / 2;          // 鏡片與中心的間隙
    
    // 鏡框顏色 - 黑色
    ctx.strokeStyle = '#000000';
    ctx.lineWidth = 6;
    ctx.fillStyle = 'rgba(50, 50, 50, 0.7)';
    
    // 左鏡片（位於中心左側，留出鼻樑空間）
    ctx.beginPath();
    ctx.roundRect(-gap - lensWidth, -height/2, lensWidth, lensHeight, 5);
    ctx.fill();
    ctx.stroke();
    
    // 右鏡片（位於中心右側，留出鼻樑空間）
    ctx.beginPath();
    ctx.roundRect(gap, -height/2, lensWidth, lensHeight, 5);
    ctx.fill();
    ctx.stroke();
    
    // 鼻樑
    ctx.beginPath();
    ctx.moveTo(-gap, 0);
    ctx.lineTo(gap, 0);
    ctx.stroke();
    
    // 左鏡腿
    ctx.beginPath();
    ctx.moveTo(-gap - lensWidth, 0);
    ctx.lineTo(-gap - lensWidth - 30, 0);
    ctx.stroke();
    
    // 右鏡腿
    ctx.beginPath();
    ctx.moveTo(gap + lensWidth, 0);
    ctx.lineTo(gap + lensWidth + 30, 0);
    ctx.stroke();
}
        


        
        
        function drawAviatorSunglasses(width, height) {
            const lensWidth = width * 0.35;
            const lensHeight = height * 0.9;
            
            ctx.strokeStyle = '#C0C0C0'; // 銀色框
            ctx.lineWidth = 4;
            ctx.fillStyle = 'rgba(100, 100, 100, 0.6)';
            
            // 左鏡片（淚滴形）
            ctx.beginPath();
            ctx.ellipse(-width/4, 0, lensWidth/2, lensHeight/2, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();
            
            // 右鏡片
            ctx.beginPath();
            ctx.ellipse(width/4, 0, lensWidth/2, lensHeight/2, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();
            
            // 鼻樑
            ctx.beginPath();
            ctx.moveTo(-lensWidth/4, -lensHeight/4);
            ctx.lineTo(lensWidth/4, -lensHeight/4);
            ctx.stroke();
            
            // 鏡腿
            ctx.beginPath();
            ctx.moveTo(-width/2 + 10, 0);
            ctx.lineTo(-width/2 - 25, 5);
            ctx.stroke();
            
            ctx.beginPath();
            ctx.moveTo(width/2 - 10, 0);
            ctx.lineTo(width/2 + 25, 5);
            ctx.stroke();
        }
        
        function drawRoundSunglasses(width, height) {
            const radius = width * 0.2;
            
            ctx.strokeStyle = '#8B4513'; // 棕色框
            ctx.lineWidth = 5;
            ctx.fillStyle = 'rgba(139, 69, 19, 0.5)';
            
            // 左鏡片
            ctx.beginPath();
            ctx.arc(-width/4, 0, radius, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();
            
            // 右鏡片
            ctx.beginPath();
            ctx.arc(width/4, 0, radius, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();
            
            // 鼻樑
            ctx.beginPath();
            ctx.moveTo(-width/4 + radius, 0);
            ctx.lineTo(width/4 - radius, 0);
            ctx.stroke();
            
            // 鏡腿
            ctx.beginPath();
            ctx.moveTo(-width/4 - radius, 0);
            ctx.lineTo(-width/2 - 20, 0);
            ctx.stroke();
            
            ctx.beginPath();
            ctx.moveTo(width/4 + radius, 0);
            ctx.lineTo(width/2 + 20, 0);
            ctx.stroke();
        }
        
        // 啟動相機
        const camera = new Camera(video, {
            onFrame: async () => {
                await faceMesh.send({image: video});
            },
            width: 1280,
            height: 720,
            facingMode: 'user' // 前置鏡頭
        });
        
        camera.start().catch(err => {
            loading.textContent = '無法訪問相機，請確認權限設定';
            console.error('Camera error:', err);
        });
    </script>
</body>
</html>
