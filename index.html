<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D è™›æ“¬å¤ªé™½çœ¼é¡ AR</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #000;
        }
        
        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        
        video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* é¡åƒç¿»è½‰ */
        }
        
        #output {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: scaleX(-1); /* é¡åƒç¿»è½‰ */
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 18px;
            text-align: center;
            background: rgba(0,0,0,0.8);
            padding: 30px 50px;
            border-radius: 15px;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        
        .loading small {
            display: block;
            margin-top: 10px;
            font-size: 14px;
            color: #aaa;
        }
        
        .controls {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 100;
        }
        
        button {
            padding: 14px 28px;
            background: rgba(255,255,255,0.95);
            border: none;
            border-radius: 30px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            color: #333;
        }
        
        button:hover {
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }
        
        button.active {
            background: #4CAF50;
            color: white;
        }
        
        .info {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 100;
            font-family: monospace;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .debug {
            position: absolute;
            top: 60px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            color: #0f0;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 100;
            font-family: monospace;
            max-width: 200px;
            display: none; /* é è¨­éš±è—ï¼Œéœ€è¦æ™‚æ”¹æˆ block */
        }
        
        @media (max-width: 768px) {
            button {
                padding: 12px 20px;
                font-size: 14px;
            }
            
            .controls {
                bottom: 20px;
                gap: 8px;
            }
        }
    </style>
</head>
<body>
    <div id="container">
        <div class="loading" id="loading">
            è¼‰å…¥ä¸­...<br>
            <small>æ­£åœ¨åˆå§‹åŒ–ç›¸æ©Ÿå’Œ AI æ¨¡å‹</small>
        </div>
        
        <video id="video" playsinline autoplay></video>
        <canvas id="output"></canvas>
        
        <div class="controls">
            <button id="model1" class="active">ç¶“å…¸æ¬¾</button>
            <button id="model2">é£›è¡Œå“¡</button>
            <button id="model3">åœ“æ¡†</button>
        </div>
        
        <div class="info" id="info">FPS: --</div>
        <div class="debug" id="debug">
            ä½ç½®: --<br>
            ç¸®æ”¾: --<br>
            æ—‹è½‰: --
        </div>
    </div>

    <!-- MediaPipe Face Mesh -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
   
    
    <!-- Three.js -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.150.0/build/three.min.js"></script>

    <script>
        // ==================== å…¨åŸŸè®Šæ•¸ ====================
        const video = document.getElementById('video');
        const canvas = document.getElementById('output');
        const loading = document.getElementById('loading');
        const infoDiv = document.getElementById('info');
        const debugDiv = document.getElementById('debug');
        
        let scene, camera, renderer, glassesModel;
        let currentStyle = 'classic';
        let lastTime = Date.now();
        let frameCount = 0;
        
        // å•Ÿç”¨é™¤éŒ¯æ¨¡å¼ï¼ˆè¨­ç‚º true å¯ä»¥çœ‹åˆ°åº§æ¨™è³‡è¨Šï¼‰
        const DEBUG_MODE = false;
        if (DEBUG_MODE) {
            debugDiv.style.display = 'block';
        }
        
        // ==================== Three.js å ´æ™¯è¨­å®š ====================
        function initThreeJS() {
            console.log('åˆå§‹åŒ– Three.js...');
            
            // å»ºç«‹å ´æ™¯
            scene = new THREE.Scene();
            
            // å»ºç«‹é€è¦–ç›¸æ©Ÿ
            const aspect = window.innerWidth / window.innerHeight;
            camera = new THREE.PerspectiveCamera(63, aspect, 0.1, 1000);
            camera.position.set(0, 0, 0);
            
            // å»ºç«‹ WebGL æ¸²æŸ“å™¨
            renderer = new THREE.WebGLRenderer({
                canvas: canvas,
                alpha: true,
                antialias: true
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setClearColor(0x000000, 0);
            
            // æ·»åŠ ç’°å¢ƒå…‰
            const ambientLight = new THREE.AmbientLight(0xffffff, 1.2);
            scene.add(ambientLight);
            
            // æ·»åŠ æ–¹å‘å…‰ï¼ˆæ¨¡æ“¬å¤ªé™½å…‰ï¼‰
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(0, 1, 1);
            scene.add(directionalLight);
            
            // æ·»åŠ é¡å¤–çš„å´å…‰
            const sideLight = new THREE.DirectionalLight(0xffffff, 0.4);
            sideLight.position.set(-1, 0, 0.5);
            scene.add(sideLight);
            
            console.log('âœ“ Three.js åˆå§‹åŒ–å®Œæˆ');
        }
        
        // ==================== å»ºç«‹ç¶“å…¸æ¬¾çœ¼é¡ ====================
        function createClassicGlasses() {
            const group = new THREE.Group();
            
            // æè³ªå®šç¾©
            const frameMaterial = new THREE.MeshPhongMaterial({
                color: 0x000000,
                shininess: 80,
                specular: 0x222222
            });
            
            const lensMaterial = new THREE.MeshPhongMaterial({
                color: 0x1a1a1a,
                transparent: true,
                opacity: 0.85,
                shininess: 100,
                specular: 0x444444
            });
            
            // å·¦é¡ç‰‡
            const leftLens = new THREE.Mesh(
                new THREE.CircleGeometry(0.045, 32),
                lensMaterial
            );
            leftLens.position.set(-0.065, 0, 0);
            group.add(leftLens);
            
            // å·¦é¡æ¡†
            const leftFrame = new THREE.Mesh(
                new THREE.TorusGeometry(0.045, 0.006, 16, 32),
                frameMaterial
            );
            leftFrame.position.set(-0.065, 0, 0);
            group.add(leftFrame);
            
            // å³é¡ç‰‡
            const rightLens = new THREE.Mesh(
                new THREE.CircleGeometry(0.045, 32),
                lensMaterial
            );
            rightLens.position.set(0.065, 0, 0);
            group.add(rightLens);
            
            // å³é¡æ¡†
            const rightFrame = new THREE.Mesh(
                new THREE.TorusGeometry(0.045, 0.006, 16, 32),
                frameMaterial
            );
            rightFrame.position.set(0.065, 0, 0);
            group.add(rightFrame);
            
            // é¼»æ¨‘
            const bridge = new THREE.Mesh(
                new THREE.CylinderGeometry(0.005, 0.005, 0.03, 8),
                frameMaterial
            );
            bridge.rotation.z = Math.PI / 2;
            group.add(bridge);
            
            // å·¦é¡è…¿
            const leftTemple = new THREE.Mesh(
                new THREE.CylinderGeometry(0.004, 0.004, 0.15, 8),
                frameMaterial
            );
            leftTemple.rotation.z = Math.PI / 2;
            leftTemple.position.set(-0.14, 0, 0);
            group.add(leftTemple);
            
            // å³é¡è…¿
            const rightTemple = new THREE.Mesh(
                new THREE.CylinderGeometry(0.004, 0.004, 0.15, 8),
                frameMaterial
            );
            rightTemple.rotation.z = Math.PI / 2;
            rightTemple.position.set(0.14, 0, 0);
            group.add(rightTemple);
            
            return group;
        }
        
        // ==================== å»ºç«‹é£›è¡Œå“¡æ¬¾çœ¼é¡ ====================
        function createAviatorGlasses() {
            const group = new THREE.Group();
            
            const frameMaterial = new THREE.MeshPhongMaterial({
                color: 0xC0C0C0,  // éŠ€è‰²
                shininess: 100,
                metalness: 0.8
            });
            
            const lensMaterial = new THREE.MeshPhongMaterial({
                color: 0x2a2a2a,
                transparent: true,
                opacity: 0.8,
                shininess: 120
            });
            
            // å·¦é¡ç‰‡ï¼ˆæ©¢åœ“å½¢ï¼‰
            const leftLens = new THREE.Mesh(
                new THREE.CircleGeometry(0.05, 32),
                lensMaterial
            );
            leftLens.scale.set(1, 1.1, 1);
            leftLens.position.set(-0.065, 0, 0);
            group.add(leftLens);
            
            // å·¦é¡æ¡†
            const leftFrame = new THREE.Mesh(
                new THREE.TorusGeometry(0.05, 0.005, 16, 32),
                frameMaterial
            );
            leftFrame.scale.set(1, 1.1, 1);
            leftFrame.position.set(-0.065, 0, 0);
            group.add(leftFrame);
            
            // å³é¡ç‰‡
            const rightLens = new THREE.Mesh(
                new THREE.CircleGeometry(0.05, 32),
                lensMaterial
            );
            rightLens.scale.set(1, 1.1, 1);
            rightLens.position.set(0.065, 0, 0);
            group.add(rightLens);
            
            // å³é¡æ¡†
            const rightFrame = new THREE.Mesh(
                new THREE.TorusGeometry(0.05, 0.005, 16, 32),
                frameMaterial
            );
            rightFrame.scale.set(1, 1.1, 1);
            rightFrame.position.set(0.065, 0, 0);
            group.add(rightFrame);
            
            // é¼»æ¨‘ï¼ˆé›™æ§“è¨­è¨ˆï¼‰
            const bridgeTop = new THREE.Mesh(
                new THREE.CylinderGeometry(0.004, 0.004, 0.025, 8),
                frameMaterial
            );
            bridgeTop.rotation.z = Math.PI / 2;
            bridgeTop.position.y = 0.015;
            group.add(bridgeTop);
            
            // é¡è…¿
            const leftTemple = new THREE.Mesh(
                new THREE.CylinderGeometry(0.004, 0.004, 0.15, 8),
                frameMaterial
            );
            leftTemple.rotation.z = Math.PI / 2;
            leftTemple.position.set(-0.14, 0, 0);
            group.add(leftTemple);
            
            const rightTemple = new THREE.Mesh(
                new THREE.CylinderGeometry(0.004, 0.004, 0.15, 8),
                frameMaterial
            );
            rightTemple.rotation.z = Math.PI / 2;
            rightTemple.position.set(0.14, 0, 0);
            group.add(rightTemple);
            
            return group;
        }
        
        // ==================== å»ºç«‹åœ“æ¡†æ¬¾çœ¼é¡ ====================
        function createRoundGlasses() {
            const group = new THREE.Group();
            
            const frameMaterial = new THREE.MeshPhongMaterial({
                color: 0x8B4513,  // æ£•è‰²
                shininess: 60
            });
            
            const lensMaterial = new THREE.MeshPhongMaterial({
                color: 0x3a2817,
                transparent: true,
                opacity: 0.75,
                shininess: 80
            });
            
            const radius = 0.042;
            
            // å·¦é¡ç‰‡
            const leftLens = new THREE.Mesh(
                new THREE.CircleGeometry(radius, 32),
                lensMaterial
            );
            leftLens.position.set(-0.06, 0, 0);
            group.add(leftLens);
            
            // å·¦é¡æ¡†
            const leftFrame = new THREE.Mesh(
                new THREE.TorusGeometry(radius, 0.007, 16, 32),
                frameMaterial
            );
            leftFrame.position.set(-0.06, 0, 0);
            group.add(leftFrame);
            
            // å³é¡ç‰‡
            const rightLens = new THREE.Mesh(
                new THREE.CircleGeometry(radius, 32),
                lensMaterial
            );
            rightLens.position.set(0.06, 0, 0);
            group.add(rightLens);
            
            // å³é¡æ¡†
            const rightFrame = new THREE.Mesh(
                new THREE.TorusGeometry(radius, 0.007, 16, 32),
                frameMaterial
            );
            rightFrame.position.set(0.06, 0, 0);
            group.add(rightFrame);
            
            // é¼»æ¨‘
            const bridge = new THREE.Mesh(
                new THREE.CylinderGeometry(0.005, 0.005, 0.025, 8),
                frameMaterial
            );
            bridge.rotation.z = Math.PI / 2;
            group.add(bridge);
            
            // é¡è…¿
            const leftTemple = new THREE.Mesh(
                new THREE.CylinderGeometry(0.005, 0.005, 0.15, 8),
                frameMaterial
            );
            leftTemple.rotation.z = Math.PI / 2;
            leftTemple.position.set(-0.135, 0, 0);
            group.add(leftTemple);
            
            const rightTemple = new THREE.Mesh(
                new THREE.CylinderGeometry(0.005, 0.005, 0.15, 8),
                frameMaterial
            );
            rightTemple.rotation.z = Math.PI / 2;
            rightTemple.position.set(0.135, 0, 0);
            group.add(rightTemple);
            
            return group;
        }
        
        // ==================== åˆ‡æ›çœ¼é¡æ¨£å¼ ====================
        function switchGlassesStyle(style) {
            if (glassesModel) {
                scene.remove(glassesModel);
            }
            
            switch(style) {
                case 'classic':
                    glassesModel = createClassicGlasses();
                    console.log('åˆ‡æ›åˆ°ç¶“å…¸æ¬¾');
                    break;
                case 'aviator':
                    glassesModel = createAviatorGlasses();
                    console.log('åˆ‡æ›åˆ°é£›è¡Œå“¡æ¬¾');
                    break;
                case 'round':
                    glassesModel = createRoundGlasses();
                    console.log('åˆ‡æ›åˆ°åœ“æ¡†æ¬¾');
                    break;
            }
            
            scene.add(glassesModel);
            currentStyle = style;
        }
        
        // ==================== MediaPipe Face Mesh è¨­å®š ====================
        const faceMesh = new FaceMesh({
            locateFile: (file) => {
                return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`;
            }
        });
        
        faceMesh.setOptions({
            maxNumFaces: 1,
            refineLandmarks: true,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });
        
        faceMesh.onResults(onResults);
        
        // ==================== è™•ç†åµæ¸¬çµæœ ====================
        function onResults(results) {
            // éš±è—è¼‰å…¥æç¤º
            if (loading.style.display !== 'none') {
                loading.style.display = 'none';
            }
            
            // è¨ˆç®— FPS
            frameCount++;
            const now = Date.now();
            if (now - lastTime > 1000) {
                infoDiv.textContent = `FPS: ${frameCount}`;
                frameCount = 0;
                lastTime = now;
            }
            
            // æ›´æ–°çœ¼é¡ä½ç½®
            if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
                const landmarks = results.multiFaceLandmarks[0];
                updateGlassesPosition(landmarks);
            } else {
                // æ²’åµæ¸¬åˆ°è‡‰éƒ¨ï¼Œéš±è—çœ¼é¡
                if (glassesModel) {
                    glassesModel.visible = false;
                }
            }
            
            // æ¸²æŸ“å ´æ™¯
            renderer.render(scene, camera);
        }
        
        // ==================== æ›´æ–°çœ¼é¡ä½ç½®ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰====================
        function updateGlassesPosition(landmarks) {
            if (!glassesModel) return;
            
            glassesModel.visible = true;
            
            // MediaPipe é—œéµç‰¹å¾µé»
            const leftEyeOuter = landmarks[33];    // å·¦çœ¼å¤–è§’
            const rightEyeOuter = landmarks[263];  // å³çœ¼å¤–è§’
            const leftEyeInner = landmarks[133];   // å·¦çœ¼å…§è§’
            const rightEyeInner = landmarks[362];  // å³çœ¼å…§è§’
            const noseTip = landmarks[1];          // é¼»å°–
            
            // ===== è¨ˆç®—ä¸­å¿ƒä½ç½® =====
            const centerX = (leftEyeOuter.x + rightEyeOuter.x) / 2;
            const centerY = (leftEyeOuter.y + rightEyeOuter.y) / 2;
            const centerZ = (leftEyeOuter.z + rightEyeOuter.z) / 2;
            
            // ===== åº§æ¨™è½‰æ›ï¼ˆMediaPipe â†’ Three.jsï¼‰=====
            const videoAspect = video.videoWidth / video.videoHeight;
            const x = (centerX - 0.5) * 2 * videoAspect;
            const y = -(centerY - 0.5) * 2;
            const z = -0.5;  // å›ºå®šæ·±åº¦
            
            glassesModel.position.set(x, y, z);
            
            // ===== è¨ˆç®—æ—‹è½‰è§’åº¦ =====
            // Roll (å·¦å³æ­ªé ­)
            const roll = Math.atan2(
                rightEyeOuter.y - leftEyeOuter.y,
                rightEyeOuter.x - leftEyeOuter.x
            );
            
            // Yaw (å·¦å³è½‰é ­) - ç°¡åŒ–ç‰ˆ
            const faceWidth = rightEyeInner.x - leftEyeInner.x;
            const yaw = (faceWidth - 0.15) * 2;
            
            // Pitch (ä¸Šä¸‹é»é ­) - ç°¡åŒ–ç‰ˆ
            const pitch = -(centerY - noseTip.y) * 3;
            
            glassesModel.rotation.set(pitch, yaw, roll);
            
            // ===== è¨ˆç®—ç¸®æ”¾ =====
            const eyeDistance = Math.sqrt(
                Math.pow((rightEyeOuter.x - leftEyeOuter.x) * videoAspect, 2) +
                Math.pow(rightEyeOuter.y - leftEyeOuter.y, 2)
            );
            
            // èª¿æ•´é€™å€‹æ•¸å€¼ä¾†æ”¹è®Šçœ¼é¡å¤§å°ï¼ˆ1.0-2.5ï¼‰
            const baseScale = 1.6;
            const scale = eyeDistance * baseScale;
            glassesModel.scale.set(scale, scale, scale);
            
            // ===== é™¤éŒ¯è³‡è¨Š =====
            if (DEBUG_MODE && frameCount % 10 === 0) {
                debugDiv.innerHTML = `
                    ä½ç½®: ${x.toFixed(2)}, ${y.toFixed(2)}, ${z.toFixed(2)}<br>
                    ç¸®æ”¾: ${scale.toFixed(2)}<br>
                    æ—‹è½‰: ${(pitch*57.3).toFixed(0)}Â°, ${(yaw*57.3).toFixed(0)}Â°, ${(roll*57.3).toFixed(0)}Â°
                `;
            }
        }
        
        // ==================== æŒ‰éˆ•äº‹ä»¶ ====================
        document.getElementById('model1').addEventListener('click', () => {
            switchGlassesStyle('classic');
            updateActiveButton('model1');
        });
        
        document.getElementById('model2').addEventListener('click', () => {
            switchGlassesStyle('aviator');
            updateActiveButton('model2');
        });
        
        document.getElementById('model3').addEventListener('click', () => {
            switchGlassesStyle('round');
            updateActiveButton('model3');
        });
        
        function updateActiveButton(activeId) {
            document.querySelectorAll('button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(activeId).classList.add('active');
        }
        
        // ==================== è¦–çª—å¤§å°èª¿æ•´ ====================
        window.addEventListener('resize', () => {
            const aspect = window.innerWidth / window.innerHeight;
            camera.aspect = aspect;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
        
        // ==================== åˆå§‹åŒ–å•Ÿå‹• ====================
        async function init() {
            console.log('ğŸš€ é–‹å§‹åˆå§‹åŒ–æ‡‰ç”¨...');
            
            try {
                // 1. åˆå§‹åŒ– Three.js
                initThreeJS();
                
                // 2. å»ºç«‹é è¨­çœ¼é¡ï¼ˆç¶“å…¸æ¬¾ï¼‰
                switchGlassesStyle('classic');
                
                // 3. å•Ÿå‹•ç›¸æ©Ÿ
                console.log('ğŸ“· å•Ÿå‹•ç›¸æ©Ÿ...');
                const cameraInstance = new Camera(video, {
                    onFrame: async () => {
                        await faceMesh.send({image: video});
                    },
                    width: 1280,
                    height: 720,
                    facingMode: 'user'
                });
                
                await cameraInstance.start();
                console.log('âœ“ ç›¸æ©Ÿå•Ÿå‹•æˆåŠŸ');
                console.log('âœ“ æ‡‰ç”¨åˆå§‹åŒ–å®Œæˆ');
                
            } catch (error) {
                console.error('âŒ åˆå§‹åŒ–å¤±æ•—:', error);
                loading.innerHTML = `
                    ç„¡æ³•è¨ªå•ç›¸æ©Ÿ<br>
                    <small>è«‹ç¢ºèªç€è¦½å™¨æ¬Šé™è¨­å®š</small>
                `;
            }
        }
        
        // å•Ÿå‹•æ‡‰ç”¨
        init();
    </script>
</body>
</html>

